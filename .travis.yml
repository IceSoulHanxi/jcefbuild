language: java

addons:
  homebrew:
    packages:
      - ninja
      - ant
      - pyenv
    taps: AdoptOpenJDK/openjdk
    casks: adoptopenjdk8-openj9

  apt:
    update: true
    sources:
      - llvm-toolchain-xenial-8 # https://docs.travis-ci.com/user/installing-dependencies/#adding-apt-sources
    packages:
      - ninja-build
      - cmake
      - clang-8
      - build-essential
      - libgtk2.0-dev
git:
  depth: false

matrix:
  fast_finish: true
  include:
    - os: linux
      dist: xenial
      compiler: clang-8
      jdk: openjdk8
      env: ARCH_DIST=linux64 CC=clang-8 CXX=clang++-8
    - os: osx
      compiler: clang
      env: ARCH_DIST=macosx64
  allow_failures:
    - os: osx

# see https://github.com/travis-ci/travis-ci/issues/8408
before_install:
  - unset _JAVA_OPTIONS

before_script:
  - pyenv update && pyenv install --list && pyenv install 2.7.16
  - git clone https://github.com/chromiumembedded/java-cef.git src
  - ./apply-patches.sh ./src
  - source setup-jdk.sh

script:
  - ./build.sh src

before_deploy:
  - cd ./packaging && ./gradlew -DBIN_ARTIFACT=../src/binary_distrib --info jcef

deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: HAIzTDzzNT4RrN3PHZ69Rzdiqul6S+p30SvN/eKjVNmVxf6qssOjNPvL5i0v+rez2K8fAdIivY401KdOr7hNNQ66JpyomWP4AYSl3tpD9y+j8A2HhgOgyKM6s66ffRDV1R/zDrg2WPEzDvjGTaP5typayRA/2ud54oaZXfg6eZc/aeKKos0bqMXwj57MsJNvGl5PxEn+m4GCBa6j36140Ct5S19HYNjx57bFD3fQZS81ex+gkrZievSlWTTR28VbPvtOANA1MoIkyX+yIVaawfS0jr5Hv2fgqHjMu8FVSK7UBhBReil1EhNYFoCCr6UleRbOBi0hBX+wAC6u6Ni9MzaZKzt493t6OhRnmNSTxmMcWcevv37XYDoPHDgoUu/9PrUO3NOVBhj+0aqQxwYmuhA4sTwhTS9cb2riNOvIRDFxpu6UEDaW+qa+lpR6iZ8qyx3w0La1d2ZZ2kQLqQ/t8Ev0RIlx51tyA0XoDfjPttCWdK5O1+kmPQmOSMZ+8m9GDVD1zITJ3zjKX2l3Oa/uFNh1oer0o2Fr4LHgwwSZlVyHRQF3rJ2m1s1vhtEN2WJYN/IPp8M61rIJpWcQsRjWRHOd667CsbMxKHvHG4NY8GwGcb9WCswrlRFCdXTIc9laIGyigszGqIjx5s5+p1PH4MoqX5IxrLjgpX+SgHop6Uw=
  file_glob: true
  file: build/distributions/*.zip
  on:
    tags: true
    repo: smac89/java-cef-build
